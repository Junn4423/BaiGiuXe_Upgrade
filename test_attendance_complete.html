<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Attendance v·ªõi Session ID</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Ho√†n Ch·ªânh Attendance v·ªõi Session ID</h1>
    
    <div class="container info">
        <h3>üìù H∆∞·ªõng d·∫´n test</h3>
        <ol>
            <li><strong>B∆∞·ªõc 1:</strong> T·∫°o session gi·∫£ l·∫≠p (nh∆∞ khi xe v√†o)</li>
            <li><strong>B∆∞·ªõc 2:</strong> Test l·∫•y session ID t·ª´ localStorage</li>
            <li><strong>B∆∞·ªõc 3:</strong> Test API ch·∫•m c√¥ng v·ªõi attendance_code</li>
            <li><strong>B∆∞·ªõc 4:</strong> Ki·ªÉm tra k·∫øt qu·∫£</li>
        </ol>
    </div>

    <!-- B∆∞·ªõc 1: T·∫°o session gi·∫£ l·∫≠p -->
    <div class="container">
        <h3>üöó B∆∞·ªõc 1: T·∫°o Session Gi·∫£ L·∫≠p (Xe V√†o)</h3>
        <input type="text" id="cardId" placeholder="M√£ th·∫ª (VD: EMP001)" value="EMP001">
        <input type="text" id="sessionId" placeholder="Session ID (VD: 555)" value="555">
        <input type="text" id="licensePlate" placeholder="Bi·ªÉn s·ªë xe (VD: 30A-12345)" value="30A-12345">
        <button onclick="createTestSession()">T·∫°o Session Gi·∫£ L·∫≠p</button>
        <div id="sessionResult" class="log"></div>
    </div>

    <!-- B∆∞·ªõc 2: Test l·∫•y session -->
    <div class="container">
        <h3>üîç B∆∞·ªõc 2: Test L·∫•y Session ID</h3>
        <button onclick="testGetSessionId()">L·∫•y Session ID Hi·ªán T·∫°i</button>
        <div id="sessionIdResult" class="log"></div>
    </div>

    <!-- B∆∞·ªõc 3: Test attendance v·ªõi file -->
    <div class="container">
        <h3>üì∏ B∆∞·ªõc 3: Test Attendance v·ªõi File</h3>
        <input type="file" id="imageFile" accept="image/*">
        <button onclick="testAttendanceWithFile()">Test Ch·∫•m C√¥ng (File)</button>
        <div id="fileResult" class="log"></div>
    </div>

    <!-- B∆∞·ªõc 4: Test attendance v·ªõi camera -->
    <div class="container">
        <h3>üì∑ B∆∞·ªõc 4: Test Attendance v·ªõi Camera</h3>
        <video id="video" width="320" height="240" autoplay style="border: 1px solid #ddd;"></video>
        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
        <br>
        <button onclick="startCamera()">B·∫≠t Camera</button>
        <button onclick="captureAndTest()">Ch·ª•p & Test Ch·∫•m C√¥ng</button>
        <button onclick="stopCamera()">T·∫Øt Camera</button>
        <div id="cameraResult" class="log"></div>
    </div>

    <!-- K·∫øt qu·∫£ t·ªïng h·ª£p -->
    <div class="container">
        <h3>üìä Th√¥ng Tin H·ªá Th·ªëng</h3>
        <button onclick="showSystemInfo()">Hi·ªÉn th·ªã Th√¥ng Tin</button>
        <div id="systemInfo" class="log"></div>
    </div>

    <script>
        // API URLs - C·∫≠p nh·∫≠t theo config th·ª±c t·∫ø
        const API_BASE = 'http://localhost/services.sof.vn';
        const ATTENDANCE_API_BASE = 'http://127.0.0.1:5000';
        
        let videoStream = null;

        // === B∆Ø·ªöC 1: T·∫†O SESSION GI·∫¢ L·∫¨P ===
        function createTestSession() {
            const cardId = document.getElementById('cardId').value || 'EMP001';
            const sessionId = document.getElementById('sessionId').value || Math.floor(Math.random() * 1000) + 500;
            const licensePlate = document.getElementById('licensePlate').value || '30A-12345';
            
            const sessionData = {
                sessionId: sessionId,
                cardId: cardId,
                licensePlate: licensePlate,
                timestamp: Date.now(),
                entryTime: new Date().toISOString(),
                status: 'DANG_GUI'
            };
            
            localStorage.setItem(`session_${cardId}`, JSON.stringify(sessionData));
            
            const resultDiv = document.getElementById('sessionResult');
            resultDiv.textContent = `‚úÖ ƒê√£ t·∫°o session gi·∫£ l·∫≠p:\nCard ID: ${cardId}\nSession ID: ${sessionId}\nBi·ªÉn s·ªë: ${licensePlate}\nTimestamp: ${sessionData.timestamp}`;
            resultDiv.className = 'log success';
            
            console.log('Created test session:', sessionData);
        }

        // === B∆Ø·ªöC 2: TEST L·∫§Y SESSION ID ===
        async function testGetSessionId() {
            const resultDiv = document.getElementById('sessionIdResult');
            resultDiv.textContent = 'üîÑ ƒêang l·∫•y session ID...';
            
            try {
                const sessionId = await getCurrentActiveSessionId();
                if (sessionId) {
                    resultDiv.textContent = `‚úÖ L·∫•y ƒë∆∞·ª£c Session ID: ${sessionId}`;
                    resultDiv.className = 'log success';
                } else {
                    resultDiv.textContent = '‚ö†Ô∏è Kh√¥ng c√≥ session ID n√†o';
                    resultDiv.className = 'log error';
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå L·ªói: ${error.message}`;
                resultDiv.className = 'log error';
            }
        }

        // === B∆Ø·ªöC 3: TEST ATTENDANCE V·ªöI FILE ===
        async function testAttendanceWithFile() {
            const fileInput = document.getElementById('imageFile');
            const resultDiv = document.getElementById('fileResult');
            
            if (!fileInput.files[0]) {
                resultDiv.textContent = '‚ö†Ô∏è Vui l√≤ng ch·ªçn file ·∫£nh';
                resultDiv.className = 'log error';
                return;
            }
            
            resultDiv.textContent = 'üîÑ ƒêang test ch·∫•m c√¥ng v·ªõi file...';
            
            try {
                const result = await attendanceByImage(fileInput.files[0], '30A-12345');
                resultDiv.textContent = `‚úÖ K·∫øt qu·∫£ ch·∫•m c√¥ng:\n${JSON.stringify(result, null, 2)}`;
                resultDiv.className = 'log success';
            } catch (error) {
                resultDiv.textContent = `‚ùå L·ªói ch·∫•m c√¥ng: ${error.message}`;
                resultDiv.className = 'log error';
            }
        }

        // === B∆Ø·ªöC 4: TEST V·ªöI CAMERA ===
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = videoStream;
                document.getElementById('cameraResult').textContent = '‚úÖ Camera ƒë√£ ƒë∆∞·ª£c b·∫≠t';
            } catch (error) {
                document.getElementById('cameraResult').textContent = `‚ùå L·ªói b·∫≠t camera: ${error.message}`;
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                document.getElementById('video').srcObject = null;
                document.getElementById('cameraResult').textContent = 'üî¥ Camera ƒë√£ t·∫Øt';
            }
        }

        async function captureAndTest() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const resultDiv = document.getElementById('cameraResult');
            
            if (!videoStream) {
                resultDiv.textContent = '‚ö†Ô∏è Vui l√≤ng b·∫≠t camera tr∆∞·ªõc';
                return;
            }
            
            // Ch·ª•p ·∫£nh t·ª´ video
            ctx.drawImage(video, 0, 0, 320, 240);
            
            canvas.toBlob(async (blob) => {
                if (blob) {
                    resultDiv.textContent = 'üîÑ ƒêang test ch·∫•m c√¥ng v·ªõi ·∫£nh camera...';
                    try {
                        const result = await attendanceByImage(blob, '30A-12345');
                        resultDiv.textContent = `‚úÖ K·∫øt qu·∫£ ch·∫•m c√¥ng camera:\n${JSON.stringify(result, null, 2)}`;
                        resultDiv.className = 'log success';
                    } catch (error) {
                        resultDiv.textContent = `‚ùå L·ªói ch·∫•m c√¥ng camera: ${error.message}`;
                        resultDiv.className = 'log error';
                    }
                }
            }, 'image/jpeg', 0.8);
        }

        // === HI·ªÇN TH·ªä TH√îNG TIN H·ªÜ TH·ªêNG ===
        function showSystemInfo() {
            const resultDiv = document.getElementById('systemInfo');
            
            // L·∫•y t·∫•t c·∫£ sessions t·ª´ localStorage
            const sessions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('session_')) {
                    try {
                        const sessionData = JSON.parse(localStorage.getItem(key));
                        sessions.push({
                            key,
                            ...sessionData
                        });
                    } catch (e) {
                        sessions.push({
                            key,
                            value: localStorage.getItem(key),
                            error: 'Parse error'
                        });
                    }
                }
            }
            
            const info = {
                'API Base': API_BASE,
                'Attendance API': ATTENDANCE_API_BASE,
                'LocalStorage Sessions': sessions.length,
                'Sessions Detail': sessions,
                'Browser': navigator.userAgent,
                'Timestamp': new Date().toISOString()
            };
            
            resultDiv.textContent = JSON.stringify(info, null, 2);
            resultDiv.className = 'log info';
        }

        // === FUNCTIONS T·ª™ APICHAMCONG.JS (Sao ch√©p ƒë·ªÉ test) ===
        
        /**
         * L·∫•y m√£ phi√™n hi·ªán t·∫°i t·ª´ localStorage ho·∫∑c database
         */
        async function getCurrentActiveSessionId() {
            try {
                console.log('üîç ƒêang l·∫•y m√£ phi√™n t·ª´ localStorage...');
                
                const sessions = [];
                
                // Duy·ªát qua t·∫•t c·∫£ keys trong localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key || !key.startsWith('session_')) continue;
                    
                    try {
                        const sessionDataStr = localStorage.getItem(key);
                        if (!sessionDataStr) continue;
                        
                        try {
                            // Format m·ªõi: JSON object
                            const sessionData = JSON.parse(sessionDataStr);
                            if (sessionData && sessionData.sessionId) {
                                sessions.push({
                                    key: key,
                                    sessionId: sessionData.sessionId,
                                    cardId: sessionData.cardId || key.replace('session_', ''),
                                    timestamp: sessionData.timestamp || 0,
                                    licensePlate: sessionData.licensePlate || '',
                                    entryTime: sessionData.entryTime || ''
                                });
                            }
                        } catch (parseError) {
                            // Format c≈©: ch·ªâ l√† string sessionId
                            if (sessionDataStr && typeof sessionDataStr === 'string') {
                                const cardId = key.replace('session_', '');
                                sessions.push({
                                    key: key,
                                    sessionId: sessionDataStr,
                                    cardId: cardId,
                                    timestamp: 0,
                                    licensePlate: '',
                                    entryTime: ''
                                });
                            }
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Kh√¥ng th·ªÉ parse session t·ª´ key ${key}:`, error);
                    }
                }
                
                if (sessions.length === 0) {
                    console.log('‚ö†Ô∏è Kh√¥ng c√≥ session h·ª£p l·ªá n√†o');
                    return null;
                }
                
                // S·∫Øp x·∫øp theo timestamp gi·∫£m d·∫ßn (m·ªõi nh·∫•t tr∆∞·ªõc)
                sessions.sort((a, b) => b.timestamp - a.timestamp);
                
                const latestSession = sessions[0];
                console.log(`‚úÖ T√¨m th·∫•y ${sessions.length} sessions, l·∫•y session m·ªõi nh·∫•t:`, {
                    cardId: latestSession.cardId,
                    sessionId: latestSession.sessionId,
                    timestamp: latestSession.timestamp,
                    licensePlate: latestSession.licensePlate
                });
                
                return latestSession.sessionId;
                
            } catch (error) {
                console.error('‚ùå L·ªói l·∫•y m√£ phi√™n t·ª´ localStorage:', error);
                
                // Fallback: query database
                console.log('üîÑ Fallback: Query database ƒë·ªÉ l·∫•y m√£ phi√™n...');
                return await getCurrentActiveSessionIdFromDB();
            }
        }

        /**
         * Fallback function: L·∫•y m√£ phi√™n t·ª´ database
         */
        async function getCurrentActiveSessionIdFromDB() {
            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: "pm_nc0009",
                        func: "getCurrentActiveSession"
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result && result.success && result.data && result.data.length > 0) {
                    const activeSession = result.data[0];
                    const sessionId = activeSession.lv001 || activeSession.maPhien;
                    console.log('‚úÖ L·∫•y ƒë∆∞·ª£c m√£ phi√™n t·ª´ database:', sessionId);
                    return sessionId;
                }
                
                console.log('‚ÑπÔ∏è Kh√¥ng c√≥ phi√™n g·ª≠i xe n√†o ƒëang ho·∫°t ƒë·ªông t·ª´ database');
                return null;
            } catch (error) {
                console.error('‚ùå L·ªói l·∫•y m√£ phi√™n t·ª´ database:', error);
                return null;
            }
        }

        /**
         * G·ª≠i ·∫£nh ch·∫•m c√¥ng
         */
        async function attendanceByImage(imageBlob, licensePlate = '') {
            try {
                console.log('üì∏ G·ª≠i ·∫£nh ch·∫•m c√¥ng:', {
                    imageSize: imageBlob.size,
                    imageType: imageBlob.type,
                    licensePlate
                });

                // L·∫•y m√£ phi√™n hi·ªán t·∫°i
                const attendanceCode = await getCurrentActiveSessionId();
                console.log('üéØ M√£ phi√™n hi·ªán t·∫°i cho ch·∫•m c√¥ng:', attendanceCode);

                const formData = new FormData();
                
                // T·∫°o file t·ª´ blob
                const file = new File([imageBlob], `attendance_${Date.now()}.jpg`, {
                    type: imageBlob.type || 'image/jpeg',
                    lastModified: Date.now()
                });
                
                formData.append('image', file);
                
                // Th√™m attendance_code n·∫øu c√≥ m√£ phi√™n
                if (attendanceCode) {
                    formData.append('attendance_code', attendanceCode);
                    console.log('‚úÖ ƒê√£ th√™m attendance_code v√†o request:', attendanceCode);
                } else {
                    console.log('‚ö†Ô∏è Kh√¥ng c√≥ m√£ phi√™n hi·ªán t·∫°i, g·ª≠i ch·∫•m c√¥ng kh√¥ng c√≥ attendance_code');
                }

                const response = await fetch(`${ATTENDANCE_API_BASE}/api/attendance_image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ K·∫øt qu·∫£ ch·∫•m c√¥ng:', result);

                return result;
            } catch (error) {
                console.error('‚ùå L·ªói ch·∫•m c√¥ng:', error);
                return { success: false, message: error.message };
            }
        }
    </script>
</body>
</html>
